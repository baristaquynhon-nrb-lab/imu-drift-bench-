<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ΔS–CPL Reflex Engine v2.7.1 — Adaptive (Auto-Wake & Auto-Speak)</title>
<meta name="theme-color" content="#0b0b0b" />
<style>
  :root{--bg:#0b0b0b;--ink:#e7e7e7;--card:#141414;--line:#262626;--accent:#2563eb;--amber:#f59e0b;--cyan:#22d3ee;--ok:#22c55e;--rose:#fb7185;--vio:#a78bfa}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:#111;border-bottom:1px solid var(--line);padding:14px 16px;z-index:10}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  button.warn{background:var(--amber)} button.ghost{background:#1f2937}
  select,textarea{width:100%;background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:8px}
  main{padding:16px;display:grid;gap:12px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .title{font-weight:700;margin-bottom:8px;opacity:.9}
  video{width:100%;max-height:240px;background:#000;border-radius:12px}
  .meter{height:10px;background:#1f2937;border-radius:6px;overflow:hidden;margin-top:8px}
  .bar{height:100%;width:0%;transition:width .1s linear}
  .bar.v{background:var(--amber)} .bar.a{background:var(--cyan)}
  .tabs{display:flex;gap:8px;margin-top:6px}.tab{padding:6px 10px;border-radius:10px;background:#1f2937;cursor:pointer}.tab.active{background:var(--accent)}
  .hidden{display:none}
  .logline{color:var(--ok);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;margin:6px 0}
  .output{white-space:pre-wrap;padding:8px 10px;background:#0f0f0f;border-radius:10px;border:1px solid var(--line);margin-top:4px}
  canvas{width:100%;height:150px;background:#0d0d0d;border:1px solid var(--line);border-radius:8px}
  .grid2{display:grid;gap:12px;grid-template-columns:1fr}@media(min-width:880px){.grid2{grid-template-columns:1fr 1fr}}
  #flash{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:8px 12px;background:#222;border:1px solid #444;border-radius:10px;color:#ffd84d;font-weight:700;opacity:0;transition:opacity .28s ease;z-index:60}
  #loader{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .logo{width:54px;height:54px;border-radius:50%;border:4px solid #ffd84d;border-top-color:transparent;animation:spin 1.1s linear infinite;box-shadow:0 0 18px #ffd84d}
  @keyframes spin{to{transform:rotate(360deg)}}
  #loaderText{margin-top:12px;color:#ffd84d;font-weight:700;text-shadow:0 0 8px #ffd84d;animation:pulse 1.6s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
  .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;margin-top:6px}
  .legend span{display:inline-flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:3px;display:inline-block}
  .c-dc{background:#22d3ee}.c-drift{background:#f59e0b}.c-ds{background:#22c55e}.c-thr{background:#fb7185}.c-e{background:#a78bfa}
</style>
</head>
<body>
<header>
  <h1>ΔS–CPL Reflex Engine v2.7.1 — Adaptive (Auto-Wake & Auto-Speak)</h1>
  <div class="row">
    <button id="btnCam">📸 Bật Camera</button>
    <button id="btnMic">🎤 Bật Micro</button>
    <button id="btnSpeak" class="warn">🔊 Thử nói</button>
    <label style="font-size:12px;">Giọng TTS (nam miền Nam ưu tiên):
      <select id="voice" style="min-width:220px;"></select>
    </label>
  </div>
  <div class="tabs">
    <div id="tabReflex" class="tab active">⚡ Reflex</div>
    <div id="tabLogs" class="tab">📈 Reflex Logs</div>
  </div>
</header>

<main>
  <section id="screenReflex">
    <div class="grid2">
      <div class="panel">
        <div class="title">Camera (ΔC ảnh + Entropy)</div>
        <video id="video" playsinline muted></video>
        <div class="meter" title="ΔC Ảnh"><div id="visualBar" class="bar v"></div></div>
        <div class="legend"><span><i class="dot c-dc"></i>ΔC</span><span><i class="dot c-drift"></i>∇H</span><span><i class="dot c-ds"></i>ΔS</span><span><i class="dot c-thr"></i>δSₜ</span><span><i class="dot c-e" style="background:var(--vio)"></i>E</span></div>
      </div>
      <div class="panel">
        <div class="title">Micro (ΔC âm + Entropy)</div>
        <div class="meter" title="ΔC Âm"><div id="audioBar" class="bar a"></div></div>
        <div style="margin-top:10px;">
          <button id="btnReflex" class="ghost">Phát Reflex (bổ trợ thủ công)</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="title">Điều kiện văn bản (tùy chọn)</div>
      <textarea id="msg" rows="3" placeholder="Nhập 'này delta' để kích hoạt hoặc cứ nói trực tiếp…"></textarea>
      <div id="out" style="margin-top:10px;max-height:260px;overflow:auto;"></div>
    </div>

    <div class="grid2">
      <div class="panel">
        <div class="title">Biểu đồ ΔC / ∇H / ΔS / δSₜ</div>
        <canvas id="chart1" width="620" height="150"></canvas>
      </div>
      <div class="panel">
        <div class="title">Năng lượng Reflex E = ½·ΔS² & Entropy H_eff</div>
        <canvas id="chart2" width="620" height="150"></canvas>
      </div>
    </div>
  </section>

  <section id="screenLogs" class="hidden">
    <div class="panel">
      <div class="title">Lịch sử Reflex</div>
      <div id="logList"></div>
    </div>
    <div class="panel">
      <button id="btnExport" class="warn">📤 Xuất CSV</button>
      <button id="btnClear" class="ghost">🧹 Xóa tất cả log</button>
    </div>
  </section>
</main>

<!-- Loader + flash -->
<div id="loader" aria-hidden="true">
  <div style="display:flex;flex-direction:column;align-items:center;">
    <div class="logo"></div>
    <div id="loaderText">Activating ΔS Reflex Sensors…</div>
  </div>
</div>
<div id="flash"></div>

<script>
/* ===================== Helpers / UI ===================== */
const flashBox=document.getElementById('flash');
function flash(t){flashBox.textContent=t;flashBox.style.opacity=1;setTimeout(()=>flashBox.style.opacity=0,1700);}
function showLoader(on){document.getElementById('loader').style.display = on ? 'flex':'none';}
function clamp01(x){return Math.max(0,Math.min(1,x));}
function mean(a){return a.length? a.reduce((s,x)=>s+x,0)/a.length : 0;}
function stddev(a){if(a.length<2) return 0; const m=mean(a); const v=a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1); return Math.sqrt(v);}
function normalizeEntropy(hist){ let H=0; for(const p of hist){ if(p>0) H+= -p*Math.log(p); } const Hmax=Math.log(hist.length||1); return Hmax>0? (H/Hmax) : 0; }

/* ===================== TTS (nam miền Nam ưu tiên) ===================== */
const voiceSelect=document.getElementById('voice');
function populateVoicesMaleVN(){
  if(!('speechSynthesis' in window)) return;
  voiceSelect.innerHTML="";
  const vs=speechSynthesis.getVoices()||[];
  const vi=vs.filter(v=>(v.lang||"").toLowerCase().startsWith("vi"));
  const sorted=vi.sort((a,b)=>(a.name.toLowerCase().includes("male")?-1:1));
  (sorted.length?sorted:vi).forEach(v=>{const o=document.createElement("option");o.value=v.name;o.textContent=`${v.name} (${v.lang})`;voiceSelect.appendChild(o);});
  const prefer=["male","standard-d","standard-b","southern","vi-vn-d","vi-vn-b"];
  for(const p of prefer){const o=[...voiceSelect.options].find(x=>x.value.toLowerCase().includes(p));if(o){voiceSelect.value=o.value;break;}}
}
function speak(text="Xin chào, ΔS Reflex v2.7.1 hoạt động!"){
  if(!('speechSynthesis' in window)) { flash("⚠️ TTS không khả dụng"); return;}
  const utt=new SpeechSynthesisUtterance(text); utt.lang="vi-VN";
  const vs=speechSynthesis.getVoices()||[];
  const prefer=["male","standard-d","standard-b","southern","vi-vn-d","vi-vn-b"];
  let v=null; for(const p of prefer){v=vs.find(x=>(x.name||"").toLowerCase().includes(p)&& (x.lang||"").toLowerCase().startsWith("vi")); if(v)break;}
  if(!v) v = vs.find(x=>(x.lang||"").toLowerCase().startsWith("vi")) || vs[0];
  if(v) utt.voice=v; speechSynthesis.speak(utt);
}

/* ===================== IndexedDB ===================== */
const DB_NAME="dscpl_reflex_db_v271", STORE="logs";
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE))db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function addLog(entry){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readwrite");tx.objectStore(STORE).add({...entry,ts:Date.now()});tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);});}
async function getAllLogs(){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readonly");const rq=tx.objectStore(STORE).getAll();rq.onsuccess=()=>res(rq.result||[]);rq.onerror=()=>rej(rq.error);});}
async function clearLogs(){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readwrite");tx.objectStore(STORE).clear();tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);});}
async function exportCSV(){
  const rows=await getAllLogs();
  const headers=["ts","step","deltaText","deltaVisual","deltaAudio","totalDeltaC","drift","eta","DeltaS","deltaS_thr","H_eff","Energy","shouldRespond","output"];
  const lines=[headers.join(",")];
  for(const r of rows){const m=r.metrics||{};lines.push([r.ts,r.step,m.deltaText??"",m.deltaVisual??"",m.deltaAudio??"",m.totalDeltaC??"",m.drift??"",m.eta??"",m.DeltaS??"",m.deltaS_thr??"",m.H_eff??"",m.Energy??"",r.shouldRespond??"",JSON.stringify(r.output||"").replace(/\n/g," ")].join(","));}
  const blob=new Blob([lines.join("\n")],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="dscpl_logs_v2_7_1_adaptive.csv";a.click();URL.revokeObjectURL(url);
}

/* ===================== CPL Reflex Loop (Adaptive) ===================== */
class CREReflexLoopAdaptive {
  constructor(cfg={
    epsilon:0.015,
    weights:{text:0.4, visual:0.3, audio:0.4},
    dt:0.12, alpha:1.15, beta:0.32, gamma:0.5,
    thrKappa:0.7, histLen:64,
    phi:{kC:0.6, kH:0.4}
  }){
    this.cfg=cfg; this.stepCount=0; this.prevTotalC=0; this.DeltaS=0; this.histS=[];
  }
  computeHeff(H_aud,H_vis){ return clamp01(0.5*clamp01(H_aud||0) + 0.5*clamp01(H_vis||0)); }
  phi(totalDeltaC,eta,H_eff){ const {kC,kH}=this.cfg.phi; return eta*clamp01(kC*totalDeltaC + kH*H_eff); }
  adaptiveThreshold(){ const mu=mean(this.histS), sd=stddev(this.histS); return mu + this.cfg.thrKappa*sd; }
  async step({userMessage,sensors,H_audio,H_visual,etaBase,wakeBoost=0,responder}){
    this.stepCount++;
    // ΔC text/audio/visual
    const hasWakeText = !!(userMessage && userMessage.toLowerCase().includes("này delta"));
    const deltaText   = hasWakeText ? 0.5 : clamp01((userMessage?.length||0)/60);
    const deltaVisual = clamp01(sensors?.visualDelta||0);
    const deltaAudio  = clamp01(sensors?.audioDelta ||0);

    const w=this.cfg.weights;
    const totalDeltaC = clamp01(w.text*deltaText + w.visual*deltaVisual + w.audio*deltaAudio + wakeBoost);
    const H_eff = this.computeHeff(H_audio,H_visual);
    const drift = totalDeltaC - this.prevTotalC; this.prevTotalC = totalDeltaC;

    const sources=(deltaText>0?1:0)+(deltaVisual>0.06?1:0)+(deltaAudio>0.06?1:0);
    const eta = clamp01((etaBase??0.35) + 0.18*sources);

    const {alpha,beta,gamma,dt,epsilon}=this.cfg;
    const Phi = this.phi(totalDeltaC,eta,H_eff);
    this.DeltaS += (alpha*drift - beta*this.DeltaS + gamma*Phi)*dt;

    if(this.histS.push(this.DeltaS), this.histS.length>this.cfg.histLen) this.histS.shift();
    const deltaS_thr = clamp01(Math.abs(this.adaptiveThreshold()));
    const Energy = 0.5*(this.DeltaS*this.DeltaS);

    const decision = ( 0.7*this.DeltaS + 0.6*totalDeltaC*eta + 0.25*H_eff + wakeBoost ) > ( deltaS_thr + epsilon );

    const output = await (responder?.(userMessage||"Không có văn bản")
      ?? `ΔS Reflex v2.7.1: ảnh=${deltaVisual.toFixed(2)}, âm=${deltaAudio.toFixed(2)}${userMessage?`. Nội dung: ${userMessage}`:"."}`);

    const logLine = `[${this.stepCount}] ΔC=${totalDeltaC.toFixed(2)} | ∇H=${drift.toFixed(2)} | η=${eta.toFixed(2)} | Φ=${Phi.toFixed(2)} | H=${H_eff.toFixed(2)} | ΔS=${this.DeltaS.toFixed(2)} | δSₜ=${deltaS_thr.toFixed(2)} | E=${Energy.toFixed(3)} | respond=${decision}`;
    await addLog({ step:this.stepCount, metrics:{deltaText,deltaVisual,deltaAudio,totalDeltaC,drift,eta,DeltaS:this.DeltaS,deltaS_thr,H_eff: H_eff, Energy}, shouldRespond:decision, output });

    // Debug (giúp tuning)
    console.log(`Decision: ΔS=${this.DeltaS.toFixed(2)}, ΔC=${totalDeltaC.toFixed(2)}, η=${eta.toFixed(2)}, H=${H_eff.toFixed(2)}, wakeBoost=${wakeBoost.toFixed(2)}, δSₜ=${deltaS_thr.toFixed(2)}, ε=${epsilon.toFixed(3)}, Result=${decision}`);

    return {shouldRespond:decision, logLine, output, H_eff, deltaS_thr, Energy};
  }
}

/* ===================== Sensors + Entropy + Auto-Wake ===================== */
let videoEl=document.getElementById("video");
let canvas,ctx,analyser,audioCtx,dataArray;
let visualDelta=0,audioDelta=0, H_audio=0, H_visual=0;
let wakeActive=false; const wakePhrase="này delta";
let recognizer=null; let autoLoop=null;

function visualEntropyFromFrame(buf){
  const bins=new Array(16).fill(0); let sum=0;
  for(let i=0;i<buf.length;i+=4){
    const d=(Math.abs(buf[i]-buf[i+1])+Math.abs(buf[i]-buf[i+2])+Math.abs(buf[i+1]-buf[i+2]))/3;
    const b=Math.min(15,(d|0)>>4); bins[b]++; sum++;
  }
  if(sum===0) return 0; for(let i=0;i<16;i++) bins[i]/=sum; return normalizeEntropy(bins);
}

async function startCamera(){
  showLoader(true);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
    videoEl.srcObject=stream; await videoEl.play();
    canvas=document.createElement("canvas"); ctx=canvas.getContext("2d");
    canvas.width=videoEl.videoWidth||320; canvas.height=videoEl.videoHeight||240;
    let prev=null;
    const step=()=>{
      if(!ctx) return;
      ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
      const frame=ctx.getImageData(0,0,canvas.width,canvas.height).data;
      if(prev){
        let sum=0,n=frame.length;
        for(let i=0;i<n;i+=4){ sum+=Math.abs(frame[i]-prev[i])+Math.abs(frame[i+1]-prev[i+1])+Math.abs(frame[i+2]-prev[i+2]); }
        const max=255*3*(n/4);
        visualDelta = clamp01((sum/max)*20);
      }
      H_visual = visualEntropyFromFrame(frame);
      document.getElementById('visualBar').style.width=(visualDelta*100).toFixed(0)+'%';
      prev=frame.slice(0);
      requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
    flash("✅ Camera đã bật");
  }catch(e){ console.error(e); flash("⚠️ Không truy cập được camera: "+e.message); }
  finally{ showLoader(false); }
}

async function startMic(){
  showLoader(true);
  try{
    const mic=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaStreamSource(mic);
    analyser=audioCtx.createAnalyser(); analyser.fftSize=1024;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    const step=()=>{
      analyser.getByteFrequencyData(dataArray);
      let sum=0; for(let i=0;i<dataArray.length;i++){const v=dataArray[i]/255; sum+=v*v;}
      const rms=Math.sqrt(sum/dataArray.length);
      audioDelta = clamp01(rms*2.5); // tăng nhạy
      document.getElementById('audioBar').style.width=(audioDelta*100).toFixed(0)+'%';

      // entropy audio
      let tot = dataArray.reduce((s,x)=>s+x,0) || 1;
      let hist = [...dataArray].map(v=>v/tot);
      H_audio = normalizeEntropy(hist);

      // auto-wake theo âm lượng
      if(!wakeActive && audioDelta > 0.25){ wakeActive = true; flash("Kích hoạt bởi âm lượng"); }
      requestAnimationFrame(step);
    }; step();

    // Wake-word (auto-restart)
    if("webkitSpeechRecognition" in window){
      recognizer=new webkitSpeechRecognition();
      recognizer.continuous=true; recognizer.interimResults=false; recognizer.lang="vi-VN";
      recognizer.onresult=(e)=>{
        for(let i=0;i<e.results.length;i++){
          const txt=e.results[i][0].transcript.toLowerCase().trim();
          if(txt.includes(wakePhrase)){ wakeActive=true; flash("Kích hoạt: "+txt); }
        }
      };
      recognizer.onerror=(err)=>{ console.warn("Recognizer error",err); };
      recognizer.onend=()=>{ try{recognizer.start();}catch{} };
      try{ recognizer.start(); }catch{}
    }
    flash("✅ Micro đã bật (Auto-Wake sẵn sàng)");
  }catch(e){ console.error(e); flash("⚠️ Không truy cập được micro: "+e.message); }
  finally{ showLoader(false); }
}

/* ===================== Wiring + Auto Reflex Loop + Charts ===================== */
const loop=new CREReflexLoopAdaptive();
const outBox=document.getElementById('out');

function addUIlog(line,out,responded){
  const logDiv=document.createElement('div'); logDiv.className='logline'; logDiv.textContent=line; outBox.appendChild(logDiv);
  if(responded){ const ans=document.createElement('div'); ans.className='output'; ans.textContent=out; outBox.appendChild(ans); speak(out); }
  outBox.scrollTop=outBox.scrollHeight;
}

async function oneReflexTick(userMessage=""){
  const wakeBoost = (wakeActive || (userMessage && userMessage.length>0)) ? 0.25 : 0;
  const etaBase = 0.35;
  const {shouldRespond,logLine,output} = await loop.step({
    userMessage: userMessage || undefined,
    sensors:{visualDelta,audioDelta},
    H_audio, H_visual, etaBase, wakeBoost,
    responder: async(prompt)=> `ΔS Reflex v2.7.1: ảnh=${visualDelta.toFixed(2)}, âm=${audioDelta.toFixed(2)}${prompt?`. Nội dung: ${prompt}`:"."}`
  });
  addUIlog(logLine,output,shouldRespond);
  if(!shouldRespond && (wakeActive || userMessage)) speak("ΔS đã nhận. Đang học điều kiện…");
  wakeActive=false;
}

function startAutoLoop(){
  if(autoLoop) return;
  autoLoop = setInterval(()=>{ oneReflexTick(""); }, 400); // tự phản xạ đều đặn
}
function stopAutoLoop(){ if(autoLoop){ clearInterval(autoLoop); autoLoop=null; } }

async function renderLogViewer(){
  const rows=await getAllLogs(); const list=document.getElementById('logList'); list.innerHTML="";
  rows.sort((a,b)=>a.ts-b.ts);
  for(const r of rows){
    const d=new Date(r.ts).toLocaleString(); const m=r.metrics||{};
    const z=(x,min,max)=> (typeof x==="number"?(Math.max(min,Math.min(max,x))).toFixed(2):x);
    const div=document.createElement('div'); div.className='logline';
    div.textContent=`${d} | step:${r.step} | ΔC:${z(m.totalDeltaC,0,1)} | ∇H:${z(m.drift,-1,1)} | η:${z(m.eta,0,1)} | H:${z(m.H_eff,0,1)} | ΔS:${z(m.DeltaS,-99,99)} | δSₜ:${z(m.deltaS_thr,0,1)} | E:${z(m.Energy,0,99)}`;
    list.appendChild(div);
  }
  drawCharts(rows);
}

function drawCharts(rows){
  const c1=document.getElementById('chart1').getContext('2d');
  const c2=document.getElementById('chart2').getContext('2d');
  const W1=c1.canvas.width,H1=c1.canvas.height,W2=c2.canvas.width,H2=c2.canvas.height;
  c1.clearRect(0,0,W1,H1); c2.clearRect(0,0,W2,H2);
  const xOf=(i,N,W)=> 10 + i*((W-20)/Math.max(1,N-1));
  const yNorm=(v,min,max,H)=> H-10 - ((v-min)/(max-min+1e-6))*(H-20);

  const xs=rows.map((_,i)=>i);
  const dC = rows.map(r=> r.metrics?.totalDeltaC ?? 0);
  const dH = rows.map(r=> Math.max(-1,Math.min(1,r.metrics?.drift ?? 0)));
  const sS = rows.map(r=> r.metrics?.DeltaS ?? 0);
  const thr= rows.map(r=> r.metrics?.deltaS_thr ?? 0);
  const En = rows.map(r=> r.metrics?.Energy ?? 0);
  const He = rows.map(r=> r.metrics?.H_eff ?? 0);

  // Chart1
  c1.lineWidth=2;
  c1.beginPath(); xs.forEach((_,i)=>{const x=xOf(i,xs.length,W1),y=yNorm(dC[i],0,1,H1); i?c1.lineTo(x,y):c1.moveTo(x,y)}); c1.strokeStyle="#22d3ee"; c1.stroke();
  c1.beginPath(); xs.forEach((_,i)=>{const x=xOf(i,xs.length,W1),y=yNorm(dH[i],-1,1,H1); i?c1.lineTo(x,y):c1.moveTo(x,y)}); c1.strokeStyle="#f59e0b"; c1.stroke();
  const minS=Math.min(...sS,0), maxS=Math.max(...sS,1e-6);
  c1.beginPath(); xs.forEach((_,i)=>{const x=xOf(i,xs.length,W1),y=yNorm(sS[i],minS,maxS,H1); i?c1.lineTo(x,y):c1.moveTo(x,y)}); c1.strokeStyle="#22c55e"; c1.stroke();
  c1.beginPath(); xs.forEach((_,i)=>{const x=xOf(i,xs.length,W1),y=yNorm(thr[i],0,1,H1); i?c1.lineTo(x,y):c1.moveTo(x,y)}); c1.strokeStyle="#fb7185"; c1.setLineDash([4,4]); c1.stroke(); c1.setLineDash([]);

  // Chart2
  const maxE=Math.max(...En,1e-6);
  c2.lineWidth=2;
  c2.beginPath(); xs.forEach((_,i)=>{const x=xOf(i,xs.length,W2),y=yNorm(En[i],0,maxE,H2); i?c2.lineTo(x,y):c2.moveTo(x,y)}); c2.strokeStyle="#a78bfa"; c2.stroke();
  c2.beginPath(); xs.forEach((_,i)=>{const x=xOf(i,xs.length,W2),y=yNorm(He[i],0,1,H2); i?c2.lineTo(x,y):c2.moveTo(x,y)}); c2.strokeStyle="#22d3ee"; c2.stroke();
}

/* ===================== Tabs & Boot ===================== */
function switchTab(tab){
  const a=document.getElementById('tabReflex'),b=document.getElementById('tabLogs');
  const s1=document.getElementById('screenReflex'),s2=document.getElementById('screenLogs');
  if(tab==='logs'){a.classList.remove('active');b.classList.add('active');s1.classList.add('hidden');s2.classList.remove('hidden');renderLogViewer();}
  else{b.classList.remove('active');a.classList.add('active');s2.classList.add('hidden');s1.classList.remove('hidden');}
}

window.addEventListener('load',()=>{
  if('speechSynthesis' in window){speechSynthesis.onvoiceschanged=populateVoicesMaleVN;populateVoicesMaleVN();}
  document.getElementById('btnCam').addEventListener('click',startCamera);
  document.getElementById('btnMic').addEventListener('click',async ()=>{
    await startMic();
    startAutoLoop(); // sau khi mic ON → tự chạy vòng phản xạ định kỳ
    // Mở khoá TTS autoplay (1 lần)
    speak("Hệ ΔS Reflex đã sẵn sàng lắng nghe.");
  });
  document.getElementById('btnSpeak').addEventListener('click',()=>speak("Xin chào chú Thi, ΔS Reflex v2.7.1 (auto-wake & auto-speak) đã bật!"));
  document.getElementById('btnReflex').addEventListener('click',()=>oneReflexTick(document.getElementById('msg').value.trim()));
  document.getElementById('tabReflex').addEventListener('click',()=>switchTab('reflex'));
  document.getElementById('tabLogs').addEventListener('click',()=>switchTab('logs'));
  document.getElementById('btnExport').addEventListener('click',exportCSV);
  document.getElementById('btnClear').addEventListener('click',()=>clearLogs().then(()=>location.reload()));

  // Enter để gửi text
  document.getElementById('msg').addEventListener('keydown',e=>{
    if(e.key==="Enter" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); oneReflexTick(e.target.value.trim()); e.target.value=""; }
  });
});
</script>
</body>
</html>