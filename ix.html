<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>HTTP Time Offset (NTP-like) — Network ΔS</title>
<style>
 body{font-family:ui-sans-serif;margin:0;padding:24px;background:#0b1020;color:#e7ecff}
 .card{background:#121734;border:1px solid #1f2752;border-radius:16px;padding:16px;max-width:880px;margin:auto}
 .row{display:flex;gap:12px;flex-wrap:wrap}
 button{background:#2a60ff;color:#fff;border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
 button.secondary{background:#263155}button:disabled{opacity:.6}
 .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
 .log{white-space:pre-wrap;background:#0f1430;border:1px dashed #2a335e;border-radius:12px;padding:10px;height:200px;overflow:auto}
 a{color:#91b4ff}
</style></head><body>
<div class="card">
  <h3>③ HTTP Time Offset (NTP-like) — <span class="mono">Network ΔS</span></h3>
  <p class="mono" style="opacity:.85">ΔS: { rtt_ms, downlink } → Phenomenon: offset drift (ms). Fit tuyến tính: slope (ms/s) → ppm.</p>
  <div class="row">
    <button id="start">Start Poll</button>
    <button id="stop" class="secondary" disabled>Stop</button>
    <button id="export" class="secondary" disabled>Export CSV</button>
  </div>
  <div id="summary" class="mono" style="margin:8px 0;min-height:24px"></div>
  <div id="log" class="log mono"></div>
  <p class="mono" style="opacity:.65;font-size:12px">Default: worldtimeapi.org (UTC). Nếu bị chặn, đổi endpoint trong mã.</p>
</div>

<script>
(function(){
  // ---- utils ----
  function linfit(xs,ys){
    const n=xs.length; if(n<2) return {m:NaN,b:NaN};
    let sx=0,sy=0,sxx=0,sxy=0;
    for(let i=0;i<n;i++){const x=xs[i],y=ys[i]; sx+=x; sy+=y; sxx+=x*x; sxy+=x*y;}
    const d=n*sxx - sx*sx; if(!d) return {m:NaN,b:NaN};
    const m=(n*sxy - sx*sy)/d; const b=(sy - m*sx)/n; return {m,b};
  }
  function csvEscape(v){ if(v==null) return ""; const s=(typeof v==="string")? v : JSON.stringify(v); return '"'+s.replaceAll('"','""')+'"'; }
  function downloadCSV(rows,name){
    const h="epoch_ms,test_id,cond_json,phenomenon_json\n";
    const b=rows.map(r=>[r.t,r.id,csvEscape(r.cond),csvEscape(r.phen)].join(',')).join('\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+b],{type:'text/csv'})); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }

  // ---- elements (đặt tên an toàn, không đụng keyword) ----
  const btnStart = document.getElementById('start');
  const btnStop  = document.getElementById('stop');
  const btnExport= document.getElementById('export');
  const sumEl    = document.getElementById('summary');
  const logEl    = document.getElementById('log');

  // ---- state ----
  const rows=[]; let timer=null; let aborter=null; let hiddenCount=0;

  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden) hiddenCount++;
  });

  async function fetchServerTime(signal){
    const t0=performance.now(); const st=Date.now();
    const resp=await fetch('https://worldtimeapi.org/api/ip',{cache:'no-store', signal});
    const txt=await resp.text(); const t1=performance.now();
    let serverMs=null;
    try{
      const js=JSON.parse(txt);
      serverMs=Date.parse(js.utc_datetime || js.datetime);
    }catch(_){
      const hdr=resp.headers.get('Date');
      if(hdr) serverMs=Date.parse(hdr);
    }
    const rtt=t1 - t0;
    const localAtServer = st + rtt/2;
    const offset = Number.isFinite(serverMs) ? (serverMs - localAtServer) : NaN;
    return {rtt, serverMs, offset};
  }

  btnStart.onclick=()=>{
    rows.length=0; hiddenCount=0; sumEl.textContent='';
    logEl.textContent='Polling… keep tab in foreground 10–15 minutes để có slope sạch.';
    aborter = new AbortController();

    timer=setInterval(async ()=>{
      try{
        const t=Date.now();
        const {rtt, serverMs, offset}=await fetchServerTime(aborter.signal);
        const downlink = (navigator.connection && navigator.connection.downlink) ? navigator.connection.downlink : null;
        const cond={ rtt_ms:rtt, downlink_mbps:downlink, hidden_count:hiddenCount };
        const phen={ server_ms:serverMs, offset_ms:offset };
        rows.push({t, id:'HTTP_TIME_OFFSET', cond, phen });

        // update UI mỗi 3 mẫu
        if(rows.length>=6 && rows.length%3===0){
          const t0=rows[0].t;
          const xs=rows.map(r => (r.t - t0)/1000);                   // seconds
          const ys=rows.map(r => (Number.isFinite(r.phen.offset_ms)? r.phen.offset_ms : NaN));
          const ok = ys.every(v => Number.isFinite(v));
          const last = ys[ys.length-1];

          if(ok){
            const f=linfit(xs,ys); const msps=f.m; const ppm=(msps/1000)*1e6;
            sumEl.textContent=`drift=${msps.toFixed(6)} ms/s  |  ppm=${ppm.toFixed(2)}  |  n=${rows.length}`;
          } else {
            sumEl.textContent=`Waiting valid samples… n=${rows.length}`;
          }
          logEl.textContent=`n=${rows.length}  offset_ms≈${Number.isFinite(last)? last.toFixed(1):'NA'}  rtt=${rtt.toFixed(1)} ms  hidden=${hiddenCount}`;
        }
      }catch(e){
        if (e.name !== 'AbortError') logEl.textContent='poll error: '+e.message;
      }
    }, 3000);

    btnStart.disabled=true; btnStop.disabled=false; btnExport.disabled=true;
  };

  btnStop.onclick=()=>{
    if (timer) clearInterval(timer);
    if (aborter) aborter.abort();
    btnStop.disabled=true; btnStart.disabled=false; btnExport.disabled=(rows.length===0);
    logEl.textContent+='\nStopped. You can export CSV.';
  };

  btnExport.onclick=()=> downloadCSV(rows, `cpl_ntp_offset_${new Date().toISOString().slice(0,19)}.csv`);
})();
</script>
</body></html>
