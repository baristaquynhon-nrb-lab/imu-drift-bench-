<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<title>ΔS–CPL Mobile Reflex v2.5 (VN Auto-Speak)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0b0b; color:#e7e7e7; margin:0; }
  header { padding:16px; background:#111; position:sticky; top:0; }
  h1 { font-size:18px; margin:0 0 8px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  button { background:#16a34a; color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:600; }
  button.secondary { background:#2563eb; }
  button.warn { background:#f59e0b; }
  main { padding:16px; }
  .panel { background:#141414; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:12px; }
  .meter { height:10px; background:#1f2937; border-radius:6px; overflow:hidden; }
  .bar { height:100%; width:0%; background:#22d3ee; transition: width .1s linear; }
  .bar.v { background:#f59e0b; }
  video { width:100%; max-height:240px; background:#000; border-radius:12px; }
  textarea, input[type=text], select { width:100%; background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px; }
  label { font-size:12px; opacity:.85; }
  .tabs { display:flex; gap:10px; margin-top:12px; }
  .tab { padding:8px 12px; border-radius:10px; background:#1f2937; cursor:pointer; }
  .tab.active { background:#2563eb; }
  .hidden { display:none; }
  .logline { color:#22c55e; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; margin:6px 0; }
  .output { white-space:pre-wrap; padding:8px 10px; background:#0f0f0f; border-radius:10px; border:1px solid #262626; }
  canvas { width:100%; height:120px; background:#0d0d0d; border:1px solid #262626; border-radius:8px; }
</style>
<script type="module">
import { CREReflexLoop25 } from '../src/cre_reflex_loop_v2_5.js';
import { addLog, getAllLogs, clearLogs, exportCSV } from './db.js';

const loop = new CREReflexLoop25({ epsilon: 0.05, weights: { text: 0.4, visual: 0.4, audio: 0.2 } });
loop.addLogSink(addLog);

let visualDelta = 0, audioDelta = 0;
let videoEl, canvasEl, ctx, analyser, dataArray, audioCtx, wakeActive=false, wakePhrase="này delta";
let voiceSelect;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
  videoEl.srcObject = stream; await videoEl.play();
  canvasEl.width = videoEl.videoWidth || 320; canvasEl.height = videoEl.videoHeight || 240;
  let prevFrame;
  const step = () => {
    ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
    const frame = ctx.getImageData(0, 0, canvasEl.width, canvasEl.height).data;
    if (prevFrame) {
      let sum = 0, n = frame.length;
      for (let i=0; i<n; i+=4) {
        const d = Math.abs(frame[i]-prevFrame[i]) + Math.abs(frame[i+1]-prevFrame[i+1]) + Math.abs(frame[i+2]-prevFrame[i+2]);
        sum += d;
      }
      const maxSum = 255*3*(n/4);
      visualDelta = Math.min(1, sum / maxSum * 20);
      document.querySelector('#visualBar').style.width = (visualDelta*100).toFixed(0) + '%';
    }
    prevFrame = frame.slice(0);
    requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

async function startMic() {
  const mic = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const src = audioCtx.createMediaStreamSource(mic);
  analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024;
  dataArray = new Uint8Array(analyser.fftSize); src.connect(analyser);

  // Wake-word (vi-VN)
  let recognizer = null;
  if ("webkitSpeechRecognition" in window) {
    recognizer = new webkitSpeechRecognition();
    recognizer.continuous = true; recognizer.interimResults = false; recognizer.lang = "vi-VN";
    recognizer.onresult = (e) => {
      for (let i=0; i<e.results.length; i++) {
        const txt = e.results[i][0].transcript.toLowerCase().trim();
        if (txt.includes(wakePhrase)) { wakeActive = true; flash("Kích hoạt bởi wake-word: " + txt); }
      }
    };
    recognizer.onerror = ()=>{};
    recognizer.onend = ()=>{ try{ recognizer.start(); }catch{} };
    try { recognizer.start(); } catch {}
  }

  const step = () => {
    analyser.getByteTimeDomainData(dataArray);
    let sum = 0;
    for (let i=0; i<dataArray.length; i++) { const v = (dataArray[i] - 128) / 128; sum += v*v; }
    const rms = Math.sqrt(sum / dataArray.length);
    audioDelta = Math.min(1, rms * 3);
    document.querySelector('#audioBar').style.width = (audioDelta*100).toFixed(0) + '%';
    if (!wakeActive && audioDelta > 0.35) { wakeActive = true; flash("Kích hoạt bởi âm lượng"); }
    requestAnimationFrame(step);
  };
  step();
}

function speak(text){
  if (!('speechSynthesis' in window)) return;
  const utt = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices() || [];
  const preferred = voiceSelect?.value || "";
  let v = null;
  if (preferred) v = voices.find(x => x.name === preferred);
  if (!v) v = voices.find(x => (x.lang||"").toLowerCase().startsWith("vi"));
  if (v) utt.voice = v;
  utt.lang = "vi-VN";
  speechSynthesis.speak(utt);
}

function populateVoices(){
  if (!('speechSynthesis' in window)) return;
  voiceSelect.innerHTML = "";
  const vs = speechSynthesis.getVoices() || [];
  const viVoices = vs.filter(v => (v.lang||"").toLowerCase().startsWith("vi"));
  for (const v of viVoices) {
    const opt = document.createElement("option");
    opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  }
  // Try pick a female-ish default by name
  const prefer = ["Google tiếng Việt","Google Vietnamese","Vietnamese Female","vi-VN-Standard-A","vi-VN-Standard-B"];
  for (const p of prefer) {
    const found = [...voiceSelect.options].find(o => o.value.toLowerCase().includes(p.toLowerCase()));
    if (found) { voiceSelect.value = found.value; break; }
  }
}

function flash(text){
  const box = document.getElementById('flash');
  box.textContent = text; box.style.opacity = 1;
  setTimeout(()=> box.style.opacity = 0, 1400);
}

async function reflex(){
  const text = (document.getElementById('msg')).value.trim();
  if (!wakeActive && !text) { flash("Hãy nói 'này delta' hoặc nhập nội dung"); return; }
  const { shouldRespond, logLine, output } = await loop.step({
    userMessage: text || undefined,
    sensors: { visualDelta, audioDelta },
    options: { tts: true, ttsVoiceName: voiceSelect?.value || null },
    responder: async (prompt) => `ΔS Reflex v2.5: ảnh=${visualDelta.toFixed(2)}, âm=${audioDelta.toFixed(2)}. ${text ? "Nội dung: "+text : "Không có văn bản."}`
  });
  addUIlog(logLine, output, shouldRespond);
  if (shouldRespond) speak(output);
  (document.getElementById('msg')).value = "";
  wakeActive = false;
}

function addUIlog(line, out, responded){
  const logDiv = document.createElement('div'); logDiv.className='logline'; logDiv.textContent = line;
  document.getElementById('out').appendChild(logDiv);
  if (responded) {
    const ans = document.createElement('div'); ans.className='output'; ans.textContent = out;
    document.getElementById('out').appendChild(ans);
  }
}

async function renderLogViewer(){
  const rows = await getAllLogs();
  const list = document.getElementById('logList');
  list.innerHTML = "";
  rows.sort((a,b)=> a.ts - b.ts);
  for (const r of rows) {
    const div = document.createElement('div'); div.className='logline';
    const d = new Date(r.ts).toLocaleString();
    const m = r.metrics || {};
    div.textContent = `${d} | step:${r.step} | ΔC:${(m.totalDeltaC??"").toFixed?m.totalDeltaC.toFixed(2):m.totalDeltaC} | ∇H:${(m.drift??"").toFixed?m.drift.toFixed(2):m.drift} | η:${(m.eta??"").toFixed?m.eta.toFixed(2):m.eta} | ΔS:${(m.DeltaS??"").toFixed?m.DeltaS.toFixed(2):m.DeltaS}`;
    list.appendChild(div);
  }
  drawChart(rows);
}

function drawChart(rows){
  const cvs = document.getElementById('chart');
  const c = cvs.getContext('2d');
  c.clearRect(0,0,cvs.width,cvs.height);
  const W = cvs.width, H = cvs.height;
  const pad = 10;
  const xs = rows.map((_,i)=> i);
  const ys1 = rows.map(r => (r.metrics?.totalDeltaC ?? 0));
  const ys2 = rows.map(r => Math.max(-1, Math.min(1, r.metrics?.drift ?? 0)));
  const ys3 = rows.map(r => (r.metrics?.eta ?? 0));

  function normY(v, min=-1, max=1){ return H - pad - ( (v - min) / (max - min + 1e-6) ) * (H - 2*pad); }
  function x(i){ return pad + i * ( (W - 2*pad) / Math.max(1, rows.length - 1) ); }

  // totalDeltaC (0..1)
  c.beginPath();
  for (let i=0;i<xs.length;i++){ const X=x(i), Y=normY(ys1[i], 0, 1); i? c.lineTo(X,Y) : c.moveTo(X,Y); }
  c.lineWidth=2; c.strokeStyle="#22d3ee"; c.stroke();

  // drift (-1..1)
  c.beginPath();
  for (let i=0;i<xs.length;i++){ const X=x(i), Y=normY(ys2[i], -1, 1); i? c.lineTo(X,Y) : c.moveTo(X,Y); }
  c.lineWidth=2; c.strokeStyle="#f59e0b"; c.stroke();

  // eta (0..1)
  c.beginPath();
  for (let i=0;i<xs.length;i++){ const X=x(i), Y=normY(ys3[i], 0, 1); i? c.lineTo(X,Y) : c.moveTo(X,Y); }
  c.lineWidth=2; c.strokeStyle="#22c55e"; c.stroke();
}

function switchTab(tab){
  const a = document.getElementById('tabReflex');
  const b = document.getElementById('tabLogs');
  const s1 = document.getElementById('screenReflex');
  const s2 = document.getElementById('screenLogs');
  if (tab === 'logs'){ a.classList.remove('active'); b.classList.add('active'); s1.classList.add('hidden'); s2.classList.remove('hidden'); renderLogViewer(); }
  else { b.classList.remove('active'); a.classList.add('active'); s2.classList.add('hidden'); s1.classList.remove('hidden'); }
}

async function exportCSV(){ await window.exportCSV(); }

window.addEventListener('load', async () => {
  if ('serviceWorker' in navigator) { try { await navigator.serviceWorker.register('./serviceWorker.js'); } catch(e) {} }
  voiceSelect = document.getElementById('voice');
  if ('speechSynthesis' in window) { speechSynthesis.onvoiceschanged = populateVoices; populateVoices(); }
  videoEl = document.getElementById('video'); canvasEl = document.getElementById('canvas'); ctx = canvasEl.getContext('2d');
  document.getElementById('btnCam').addEventListener('click', startCamera);
  document.getElementById('btnMic').addEventListener('click', startMic);
  document.getElementById('btnReflex').addEventListener('click', reflex);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('tabReflex').addEventListener('click', ()=>switchTab('reflex'));
  document.getElementById('tabLogs').addEventListener('click', ()=>switchTab('logs'));
  window.exportCSV = exportCSV;
});
</script>
</head>
<body>
<header>
  <h1>ΔS–CPL Mobile Reflex v2.5 — VN Auto-Speak</h1>
  <div class="row">
    <button id="btnCam">Bật Camera</button>
    <button id="btnMic" class="secondary">Bật Micro</button>
    <label>Giọng TTS: <select id="voice"></select></label>
    <button id="btnExport" class="warn">📤 Xuất CSV</button>
  </div>
  <div class="tabs">
    <div id="tabReflex" class="tab active">⚡ Reflex</div>
    <div id="tabLogs" class="tab">📈 Reflex Logs</div>
  </div>
  <div id="flash" style="opacity:0; transition:opacity .3s ease; margin-top:6px; color:#ffd166; font-weight:700;"></div>
</header>
<main>
  <section id="screenReflex">
    <div class="panel">
      <video id="video" playsinline muted></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="meter" title="ΔC Ảnh (chuyển động)"><div id="visualBar" class="bar v"></div></div>
    </div>
    <div class="panel">
      <div class="meter" title="ΔC Âm (âm lượng)"><div id="audioBar" class="bar"></div></div>
    </div>
    <div class="panel">
      <label>Điều kiện văn bản (tùy chọn)</label>
      <textarea id="msg" placeholder="Nói 'này delta' để kích hoạt, hoặc nhập nội dung rồi bấm Reflex…"></textarea>
      <button id="btnReflex">Reflex</button>
      <div id="out"></div>
    </div>
  </section>

  <section id="screenLogs" class="hidden">
    <div class="panel">
      <canvas id="chart" width="600" height="120"></canvas>
    </div>
    <div class="panel" id="logList"></div>
    <div class="panel">
      <button onclick="window.exportCSV()">📤 Xuất CSV</button>
      <button onclick="import('./db.js').then(m=>m.clearLogs()).then(()=>location.reload())">🧹 Xóa tất cả log</button>
    </div>
  </section>
</main>
</body>
</html>
